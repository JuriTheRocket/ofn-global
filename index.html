<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organisation of Free Nations</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0a1430;
      --bg2:#071026;

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);

      --line: rgba(255,255,255,.14);
      --line2: rgba(255,255,255,.22);

      --text:#eaf0ff;
      --muted: rgba(234,240,255,.72);

      --member:#2b6dff;
      --founding:#ffcc33;
      --observer:#f2994a;
      --invite:#18a999;
      --conflict:#ff4b4b;
      --neutral:#7f9ccf;

      /* HARD EDGES */
      --r: 4px;
      --r2: 6px;

      /* industrial strokes */
      --stroke: rgba(255,255,255,.18);
      --stroke2: rgba(43,109,255,.35);

      /* harsher shadows */
      --shadow: 0 22px 0 rgba(0,0,0,.22), 0 40px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 0 rgba(0,0,0,.18), 0 18px 24px rgba(0,0,0,.35);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;

      /* glitch/noise controls */
      --grain: .16;     /* 0..1 */
      --scan: .16;      /* 0..1 */
    }

    /* ‚ÄúDay‚Äù becomes overcast terminal (NOT white) */
    :root[data-theme="day"]{
      --bg0:#e7edf9;
      --bg1:#cfdaf5;
      --bg2:#aebfe9;

      --card: rgba(10,16,32,.78);
      --card2: rgba(10,16,32,.86);

      --line: rgba(0,0,0,.22);
      --line2: rgba(0,0,0,.32);

      --text:#eef3ff;
      --muted: rgba(238,243,255,.72);

      --shadow: 0 22px 0 rgba(0,0,0,.12), 0 32px 44px rgba(0,0,0,.28);
      --shadow2: 0 10px 0 rgba(0,0,0,.10), 0 18px 22px rgba(0,0,0,.20);
    }

    :root[data-theme="night"]{
      /* explicit in case you ever set only night attribute */
      --bg0:#0b1020;
      --bg1:#0a1430;
      --bg2:#071026;
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      font: 14px/1.35 var(--ui);
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 55% 10%, rgba(43,109,255,.18), transparent 60%),
        radial-gradient(700px 500px at 15% 25%, rgba(255,204,51,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);
    }

    /* Scanlines */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      z-index:2;
      opacity: var(--scan);
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,.06) 0 1px,
          rgba(0,0,0,0) 1px 6px
        );
      mix-blend-mode: overlay;
    }

    /* Vignette + subtle vertical bars */
    body:after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      z-index:2;
      background:
        radial-gradient(1200px 800px at 50% 30%, transparent 40%, rgba(0,0,0,.55) 100%),
        repeating-linear-gradient(
          90deg,
          rgba(43,109,255,.03) 0 2px,
          rgba(0,0,0,0) 2px 14px
        );
      opacity: .22;
    }

    /* Grain layer */
    @keyframes grainShift{
      0%{ transform:translate(0,0) }
      20%{ transform:translate(-2%,1%) }
      40%{ transform:translate(1%,-2%) }
      60%{ transform:translate(2%,2%) }
      80%{ transform:translate(-1%,2%) }
      100%{ transform:translate(0,0) }
    }
    #grain{
      position:fixed; inset:-20%;
      pointer-events:none;
      z-index:3;
      opacity: var(--grain);
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      animation: grainShift 2.2s steps(2,end) infinite;
    }

    #map{ position:fixed; inset:0; z-index:1; }

    /* --- Brutal, cut-corner geometry --- */
    .cutCorner{
      clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
    }

    /* Topbar */
    #topbar{
      position:fixed; z-index:30;
      left:16px; right:16px; top:14px;
      min-height:62px;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius: 2px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(12px);
      opacity:0;
      transform: translateY(-8px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease, background .16s ease, border-color .16s ease;
      clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
    }
    #topbar.ready{ opacity:1; transform: translateY(0); pointer-events:auto; }

    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .emblem{
      width:40px; height:40px;
      border-radius: 4px;
      border:1px solid var(--stroke);
      background:
        radial-gradient(circle at 35% 30%, rgba(43,109,255,.38), rgba(27,63,191,.12) 55%, rgba(255,255,255,.10) 100%),
        linear-gradient(135deg, rgba(255,204,51,.18), transparent 45%);
      box-shadow: 0 0 0 2px rgba(255,204,51,.22), 0 0 0 7px rgba(43,109,255,.14);
      position:relative; overflow:hidden;
      flex:0 0 auto;
    }
    .emblem:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 210deg,
        rgba(255,204,51,0) 0 22%,
        rgba(255,204,51,.35) 22% 28%,
        rgba(255,204,51,0) 28% 56%,
        rgba(43,109,255,.28) 56% 64%,
        rgba(255,204,51,0) 64% 100%);
      animation: spin 9.5s linear infinite;
      opacity:.85;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .brand h1{
      margin:0;
      font: 12px/1.1 var(--mono);
      letter-spacing:.22em;
      text-transform:uppercase;
      color: var(--member);
      text-shadow: 1px 0 rgba(43,109,255,.35), -1px 0 rgba(255,204,51,.25);
    }
    .brand .sub{ margin:4px 0 0 0; font-size:12px; color:var(--muted); font-family: var(--mono); opacity:.9; }

    /* Subtle jitter for title */
    @keyframes jitter{
      0%,100%{ transform:translate(0,0) }
      92%{ transform:translate(0,0) }
      93%{ transform:translate(1px,-1px) }
      94%{ transform:translate(-1px,1px) }
      95%{ transform:translate(2px,0) }
      96%{ transform:translate(-2px,0) }
      97%{ transform:translate(1px,1px) }
      98%{ transform:translate(0,-1px) }
      99%{ transform:translate(0,0) }
    }
    #topbar.ready .brand h1{ animation: jitter 6.5s infinite; }

    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    /* Kill bubbly feel globally */
    input, select, button{
      border-radius: 2px !important;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.28);
      color: var(--text);
      padding:9px 11px;
      outline:none;
      transition: box-shadow .16s ease, border-color .16s ease, transform .10s ease, background .16s ease, color .16s ease;
      backdrop-filter: blur(10px);
      font-family: var(--mono);
      letter-spacing: .02em;
    }
    input{ min-width: 220px; }
    input::placeholder{ color: rgba(234,240,255,.55); }

    button{ cursor:pointer; }
    button{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18)) !important;
      border-color: rgba(255,255,255,.18) !important;
    }
    button:hover{
      border-color: rgba(255,255,255,.26) !important;
      box-shadow: 0 0 0 2px rgba(43,109,255,.18), 0 0 0 6px rgba(255,204,51,.08) !important;
    }
    button:active{ transform: translateY(1px); }

    .primary{
      border-color: rgba(43,109,255,.55) !important;
      background: linear-gradient(90deg, rgba(43,109,255,.28), rgba(255,204,51,.12)) !important;
    }

    /* Dropdown usability: dark popup list in BOTH themes */
    :root[data-theme="night"] select,
    :root[data-theme="day"] select{
      background: #000 !important;
      color: #fff !important;
      border-color: rgba(255,255,255,.20);
    }
    :root[data-theme="night"] select option,
    :root[data-theme="day"] select option{
      background: #000 !important;
      color: #fff !important;
    }

    #statusline{
      position:fixed; z-index:25;
      left:16px; bottom:16px;
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius: 2px;
      padding:10px 12px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(12px);
      display:flex; gap:10px; align-items:center;
      color:var(--muted);
      max-width: calc(100vw - 32px);
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .28s ease, transform .28s ease;
      clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
    }
    #statusline.ready{ opacity:1; transform: translateY(0); pointer-events:auto; }
    .pillDot{ width:9px; height:9px; border-radius:0; background:var(--member); box-shadow: 0 0 0 3px rgba(43,109,255,.18); }
    #statusline b{ color:var(--text); font-family: var(--mono); }
    #clockInfo{ display:none; white-space:nowrap; font-family: var(--mono); }
    #clockInfo.on{ display:inline; }

    #drawer{
      position:fixed; z-index:35;
      top:88px; left:16px; bottom:16px;
      width:min(480px, calc(100vw - 32px));
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius: 2px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      transform: translateX(-112%);
      transition: transform .22s ease;
      overflow:hidden;
      display:flex; flex-direction:column;
      clip-path: polygon(14px 0, 100% 0, 100% calc(100% - 14px), calc(100% - 14px) 100%, 0 100%, 0 14px);
    }
    #drawer.open{ transform: translateX(0); }

    /* Tape-label header vibe */
    .drawerHead{
      padding:14px 14px 12px 14px;
      border-bottom:1px dashed rgba(255,255,255,.22);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background: linear-gradient(90deg, rgba(255,204,51,.14), rgba(43,109,255,.12), rgba(255,255,255,.02));
    }

    .drawerTitle{ display:flex; align-items:center; gap:10px; min-width:0; }
    .flagBig{
      width:44px; height:44px;
      border-radius: 2px;
      display:grid; place-items:center;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(0,0,0,.22);
      box-shadow: 0 0 0 2px rgba(43,109,255,.18);
      font-size:22px;
      flex:0 0 auto;
    }

    .titleText{ min-width:0; }
    .titleText h2{
      margin:0; font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-family: var(--mono);
      letter-spacing:.02em;
    }
    .titleText .mini{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      font-family: var(--mono);
    }

    .badge{
      padding:4px 9px;
      border-radius: 2px !important;
      border:1px dashed rgba(255,255,255,.22) !important;
      background: rgba(0,0,0,.22) !important;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      font-family: var(--mono);
      letter-spacing:.06em;
      text-transform:uppercase;
    }

    .drawerActions{ display:flex; gap:8px; align-items:center; }
    .iconBtn{
      width:38px; height:38px;
      border-radius: 2px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      display:grid; place-items:center;
      font-family: var(--mono);
    }
    .iconBtn:hover{ box-shadow: 0 0 0 2px rgba(43,109,255,.18), 0 0 0 6px rgba(255,204,51,.08); }

    .drawerBody{
      padding:12px 14px 14px 14px;
      overflow:auto;
      display:flex; flex-direction:column; gap:10px;
      min-height:0;
    }
    .card{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 2px;
      background: rgba(0,0,0,.16);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      padding:12px;
    }

    .card h3{
      margin:0 0 8px 0;
      font: 12px/1.1 var(--mono);
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .kv{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 2px;
      padding:10px;
      background: rgba(0,0,0,.16);
    }
    .kv .k{
      font: 11px/1.1 var(--mono);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .kv .v{ margin-top:6px; font-weight:650; color:var(--text); overflow-wrap:anywhere; font-family: var(--mono); }

    .note{ margin:0; color:var(--muted); font-family: var(--ui); }
    .link{ color: var(--member); text-decoration: none; border-bottom: 1px dotted rgba(43,109,255,.65); font-family: var(--mono); }
    .link:hover{ border-bottom-color: rgba(43,109,255,.95); }

    #intro{
      position:fixed; inset:0; z-index:60;
      background: var(--bg0);
      display:grid; place-items:center;
      transition: opacity .28s ease;
    }
    #intro.hidden{ opacity:0; pointer-events:none; }
    #introCanvas{
      width:min(760px, calc(100vw - 36px));
      height:360px;
      display:block;
    }

    /* Fictional panel */
    #fictionPanel{
      position:fixed; z-index:34;
      right:16px;
      top:50%;
      transform: translateY(-50%);
      width: 320px;
      max-height: min(520px, calc(100vh - 140px));
      background: var(--card2);
      border: 1px solid var(--stroke);
      border-radius: 2px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow: hidden;
      display:flex;
      transition: transform .22s ease;
      clip-path: polygon(14px 0, 100% 0, 100% calc(100% - 14px), calc(100% - 14px) 100%, 0 100%, 0 14px);
    }
    #fictionPanel.closed{ transform: translate( calc(100% - 46px), -50% ); }

    .fictionHandle{
      width:46px;
      border-right: 1px dashed rgba(255,255,255,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(255,204,51,.10), rgba(43,109,255,.08), rgba(255,255,255,.02));
      flex:0 0 auto;
    }

    .fictionHandle button{
      width:34px; height:34px;
      padding:0;
      border-radius: 2px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.55);
      cursor:pointer;
      color:#fff;
      font-family: var(--mono);
    }
    .fictionHandle button:hover{ box-shadow: 0 0 0 2px rgba(43,109,255,.18), 0 0 0 6px rgba(255,204,51,.08); }

    .fictionBody{
      padding:12px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      width: calc(320px - 46px);
    }
    .fictionTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding-bottom:8px;
      border-bottom:1px dashed rgba(255,255,255,.22);
    }

    .fictionTitle h3{
      margin:0;
      font: 12px/1.1 var(--mono);
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .fictionHint{ font-size:12px; color:var(--muted); white-space:nowrap; font-family: var(--mono); opacity:.85; }

    .fictionList{ display:flex; flex-direction:column; gap:8px; }
    .fictionItem{
      border-radius: 2px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding:10px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      transition: transform .10s ease, border-color .16s ease, box-shadow .16s ease;
    }
    .fictionItem:hover{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(43,109,255,.18), 0 0 0 6px rgba(255,204,51,.08);
    }
    .fictionItem:active{ transform: translateY(1px); }

    .fictionItem .left{ min-width:0; }
    .fictionItem .name{
      font-weight: 760;
      margin:0;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family: var(--mono);
      letter-spacing:.02em;
    }
    .fictionItem .sub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family: var(--mono);
    }
    .fictionItem .right{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }

    .miniBadge{
      padding:3px 8px;
      border-radius:2px !important;
      border:1px dashed rgba(255,255,255,.22) !important;
      background: rgba(0,0,0,.22) !important;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      font-family: var(--mono);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .miniBadge.member{ border-color: rgba(43,109,255,.45) !important; }
    .miniBadge.invite{ border-color: rgba(24,169,153,.55) !important; }
    .miniBadge.neutral{ border-color: rgba(127,156,207,.55) !important; }

    /* Leaflet UI */
    .leaflet-control-attribution{
      background: var(--card2) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      border-radius: 2px !important;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
      color: var(--muted) !important;
      font-family: var(--mono);
    }
    .leaflet-control-zoom a{
      background: var(--card2) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      color: var(--text) !important;
      border-radius: 2px !important;
      font-family: var(--mono);
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip{
      background: var(--card2) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      box-shadow: var(--shadow2);
      color: var(--text) !important;
      backdrop-filter: blur(12px);
      border-radius: 2px !important;
      font-family: var(--ui);
    }

    @media (max-width: 720px){
      #topbar{ left:12px; right:12px; }
      #statusline{ left:12px; right:12px; max-width: calc(100vw - 24px); }
      #drawer{ left:12px; width: calc(100vw - 24px); }
      input{ min-width: 160px; }
      .grid2{ grid-template-columns:1fr; }
      #introCanvas{ height:300px; }
      #fictionPanel{ right:12px; width: 300px; }
      #fictionPanel.closed{ transform: translate( calc(100% - 44px), -50% ); }
      .fictionHandle{ width:44px; }
      .fictionBody{ width: calc(300px - 44px); }
    }

    /* OFN modal */
    #ofnOverlay{
      position:fixed; inset:0;
      z-index:80;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(12px);
    }
    #ofnOverlay.open{ display:grid; }

    #ofnModal{
      width:min(860px, calc(100vw - 28px));
      max-height: min(78vh, 760px);
      overflow:auto;
      border-radius: 2px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(900px 380px at 30% 0%, rgba(43,109,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      box-shadow: 0 26px 60px rgba(0,0,0,.65);
      position:relative;
      clip-path: polygon(16px 0, 100% 0, 100% calc(100% - 16px), calc(100% - 16px) 100%, 0 100%, 0 16px);
    }

    .ofnHead{
      padding:14px 14px 10px 14px;
      border-bottom:1px dashed rgba(255,255,255,.22);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      position:sticky; top:0;
      background: inherit;
      backdrop-filter: blur(12px);
      z-index:2;
    }
    .ofnHead h2{
      margin:0;
      font: 14px/1.1 var(--mono);
      letter-spacing:.22em;
      text-transform: uppercase;
      color: var(--text);
      text-shadow: 1px 0 rgba(43,109,255,.35), -1px 0 rgba(255,204,51,.25);
    }
    .ofnHead p{
      margin:8px 0 0 0;
      color: var(--muted);
      max-width: 64ch;
      font-size: 13px;
      font-family: var(--ui);
    }
    .ofnClose{
      width:40px; height:40px;
      border-radius: 2px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: #fff;
      cursor:pointer;
      display:grid; place-items:center;
      font-family: var(--mono);
    }

    .ofnBody{ padding:14px; display:grid; gap:12px; }
    .ofnGrid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 820px){ .ofnGrid{ grid-template-columns: 1fr; } }

    .ofnCard{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 2px;
      background: rgba(0,0,0,.16);
      padding:12px;
    }
    .ofnCard h3{
      margin:0 0 8px 0;
      font: 12px/1.1 var(--mono);
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--muted);
    }

    .ofnImgWrap{
      position:relative;
      border-radius: 2px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      box-shadow: 0 14px 28px rgba(0,0,0,.45);
      min-height: 240px;
      clip-path: polygon(18px 0, 100% 0, 100% calc(100% - 18px), calc(100% - 18px) 100%, 0 100%, 0 18px);
    }
    .ofnImgWrap img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: contrast(1.04) saturate(1.02);
    }

    /* ‚Äúwedged corners‚Äù look */
    .ofnImgWrap:before,
    .ofnImgWrap:after{
      content:"";
      position:absolute;
      width:140px; height:140px;
      background: rgba(255,255,255,.92);
      mix-blend-mode: screen;
      opacity: .10;
      pointer-events:none;
      transform: rotate(45deg);
    }
    .ofnImgWrap:before{ left:-80px; top:-80px; }
    .ofnImgWrap:after{ right:-80px; bottom:-80px; }

    .ofnBanner{
      border-radius: 2px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      height: 170px;
      position:relative;
      clip-path: polygon(18px 0, 100% 0, 100% calc(100% - 18px), calc(100% - 18px) 100%, 0 100%, 0 18px);
    }
    .ofnBanner img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      opacity: .88;
      filter: contrast(1.02) saturate(1.02);
    }
    .ofnBanner .stamp{
      position:absolute;
      left:12px; bottom:12px;
      padding:6px 10px;
      border-radius: 2px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.90);
      font: 11px/1.1 var(--mono);
      letter-spacing: .14em;
      text-transform: uppercase;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="grain" aria-hidden="true"></div>

  <div id="topbar" role="banner">
    <div class="brand">
      <div class="emblem" aria-hidden="true"></div>
      <div>
        <h1>Organisation of Free Nations</h1>
        <div class="sub">GLOBAL OPERATIONAL MAP</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <input id="search" type="text" placeholder="Search any country‚Ä¶" spellcheck="false" />
      <select id="filter">
        <option value="all">All statuses</option>
        <option value="member">Member</option>
        <option value="founding">Founding</option>
        <option value="observer">Observer</option>
        <option value="invite">Open invite</option>
        <option value="conflict">Conflict</option>
        <option value="neutral">Neutral</option>
      </select>
      <select id="theme">
        <option value="auto">Theme: Auto</option>
        <option value="day">Theme: Day</option>
        <option value="night">Theme: Night</option>
      </select>

      <button id="clockBtn" type="button" class="primary" title="Toggle timezone clock">Clock: Off</button>
      <button id="focusBtn" type="button">Member focus: Off</button>
      <button id="ofnBtn" type="button">The OFN</button>
      <button id="fitBtn" type="button">Fit</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <div id="statusline" aria-live="polite">
    <span class="pillDot"></span>
    <span>
      <b id="selName">No selection</b>
      ¬∑ <span id="selStatus">‚Äî</span>
      <span id="clockInfo"> ¬∑ <span id="clockText"></span></span>
    </span>
  </div>

  <aside id="fictionPanel" class="closed" aria-label="Fictional nations panel">
    <div class="fictionHandle">
      <button id="fictionToggle" type="button" title="Toggle fictional nations">‚óÄ</button>
    </div>
    <div class="fictionBody">
      <div class="fictionTitle">
        <h3>Fictional nations</h3>
        <div class="fictionHint">click to open</div>
      </div>
      <div class="fictionList" id="fictionList"></div>
    </div>
  </aside>

  <aside id="drawer" aria-label="Country details panel">
    <div class="drawerHead">
      <div class="drawerTitle">
        <div class="flagBig" id="dFlag">üåç</div>
        <div class="titleText">
          <h2 id="dName">‚Äî</h2>
          <div class="mini" id="dMini"></div>
        </div>
      </div>
      <div class="drawerActions">
        <button class="iconBtn" id="zoomBtn" type="button" title="Zoom to country">‚§¢</button>
        <button class="iconBtn" id="closeBtn" type="button" title="Close">‚úï</button>
      </div>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </aside>

  <!-- OFN modal -->
  <div id="ofnOverlay" role="dialog" aria-modal="true" aria-label="The OFN information">
    <div id="ofnModal">
      <div class="ofnHead">
        <div>
          <h2>The OFN</h2>
          <p>
            The Organisation of Free Nations coordinates member-state cooperation in security, stability, humanitarian response,
            and the defense of constitutional order ‚Äî a network built to keep peace from being a ‚Äútemporary setting.‚Äù
          </p>
        </div>
        <button class="ofnClose" id="ofnClose" type="button" title="Close">‚úï</button>
      </div>

      <div class="ofnBody">
        <div class="ofnBanner">
          <img src="ofn2.png" alt="OFN peacekeepers in the field">
          <div class="stamp">Field operations</div>
        </div>

        <div class="ofnGrid">
          <div class="ofnCard">
            <h3>Mandate</h3>
            <p class="note" style="margin:0 0 10px 0;">
              Collective action where states request support, where peace is threatened, and where rule-of-law institutions require protection.
              The OFN operates as a framework ‚Äî not a conquest machine, not a flag-collection hobby.
            </p>
            <p class="note" style="margin:0;">
              This map shows membership status, observers, invitations, and fictional nations used in your roleplay universe.
            </p>
          </div>

          <div class="ofnImgWrap" aria-label="OFN imagery">
            <img src="ofn1.png" alt="OFN peacekeepers operating in contested terrain">
          </div>
        </div>

        <div class="ofnCard">
          <h3>How to use this page</h3>
          <p class="note" style="margin:0;">
            Click a country to open the dossier panel. Use <b>Clock</b> to view local time estimates based on geographic longitude.
            Use <b>Member focus</b> to spotlight member and founding states. Use <b>Theme</b> to swap the atmosphere.
          </p>
        </div>
      </div>
    </div>
  </div>

  <section id="intro" aria-label="Loading">
    <canvas id="introCanvas"></canvas>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Bump this when you want to brute-force cache busting while testing deploys
    const BUILD_VERSION = "2026-02-28-3";

    const OFN = {
      members: new Set(["Luxembourg","Falkland Islands","Israel","United States of America","Philippines","Australia","Greece","Georgia","Ireland"]),
      founding: new Set(["Falkland Islands"]),
      observer: new Set(["China","Brazil","Portugal"]),
      invite: new Set(["Japan","France","Qatar"]),
      conflict: new Set([]),
      hq: "Luxembourg"
    };

    // Fictional nations (not on the real-world map)
    const FICTIONAL = new Map([
      ["State of Mayflower (Union of Columbia)", {
        status: "member",
        flag: "üü¶",
        meta: {
          "Polity": "Union of Columbia (Mayflower)",
          "Seat of government": "City of Lander (County of Clark)",
          "Administrative areas": "New Haven ¬∑ Lee ¬∑ Clark ¬∑ Elizabeth"
        },
        overview: [
          "The State of Mayflower was established along the northeast coast of the current day Union of Columbia by colonizers hailing from Pax Britannia in December of 1771.",
          "The State of Mayflower had human settlements within its boundaries as early as 1625, with human settlements from the Kingdom of Wallonia sporadically being created along the coast.",
          "The state was established as an entity of the Union of Columbia on 4 July 1776 proceeding the uprising against Pax Britannia for independence.",
          "The state ecompasses a variety of natural areas, including rivers, mountains, valleys, and numerous accompanying waterways that divide land into islands that create state boundaries.",
          "The state is made up the administrative areas of the County of New Haven, County of Lee, County of Clark, and the County of Elizabeth.",
          "The state is seated in the City of Lander in the County of Clark."
        ].join("\n\n")
      }],
      ["State of Ashford", {
        status: "neutral",
        flag: "üü™",
        meta: {
          "Status": "United States territory",
          "Founded": "1763",
          "Capital": "Ember Township (formerly Ember City)"
        },
        overview: [
          "The State of Ashford, also known as Ashford, was founded in 1763 by settlers who crossed the Atlantic seeking freedom and opportunity under the leadership of Sir Clifford. Their journey was marked by hardship and tragedy, including a pirate attack that claimed many lives, among them Sir Clifford himself.",
          "In their memory, the settlers built Ember City, later known as Ember Township, and named their land Ashford. A symbol of resilience born from loss and determination.",
          "Today, Ashford stands proudly as a United States territory in Washington, committed to the values of liberty, democracy, and cooperation."
        ].join("\n\n")
      }],
      ["State of Firestone", {
        status: "invite",
        flag: "üü©",
        meta: {
          "Founded": "April 1st, 2016",
          "Founders": "FedoraMasterB98 ¬∑ pathwaysbball",
          "Current owner": "Poe_DameronTR",
          "Motto": "United We Stand"
        },
        overview: [
          "The State of Firestone, founded on April 1st, 2016 by FedoraMasterB98 and pathwaysbball, is a longstanding and prominent Ro-State roleplay community based within the United States. Now under the ownership of Poe_DameronTR, Firestone is entering a new era one focused on revitalization, transparency, and delivering a more immersive experience for all.",
          "Since its creation, Firestone has allowed members to step into government, law enforcement, civilian, and criminal roles in a dynamic and realistic environment. Our core belief \"United We Stand\" remains stronger than ever as we work toward uniting the community through collaboration, innovation, and renewed purpose."
        ].join("\n\n")
      }],
      ["Yellonia", {
        status: "neutral",
        flag: "üü®",
        meta: {
          "Founded": "1943",
          "Founders": "IronOoof",
          "Capital": "Yeloria",
          "Motto": "AVE YELLONIA!"
        },
        overview: [
          "The Empire of Yellonia was founded by IronOoof after a successful victory in the 1st Solesian Civil War in 1643. The nation was steadily reunified and was made into a loose grouping of states, each having their own currency, own laws, and more. serving as a democratic nation that ensures stability within the continent.",
          "After 10 years of in-fighting, the states were unified with an Emperor to lead them, the first Emperor being IronOoof. A Parliament was then established in 1923, to handle laws and ensure that the citizens of Yellonia had power in the nation."
        ].join("\n\n")
      }],
      ["Commonwealth of New Haven (Lander City)", {
        status: "member",
        flag: "üü¶",
        meta: {
          "Capital": "Lander City",
          "Official Language": "English",
          "Government": "Representative Democracy"
        },
        overview: [
          "The Commonwealth of New Haven is a sovereign nation founded on the principles of stability, self-governance, and collective prosperity. Built as a refuge from disorder, New Haven blends strong federal authority with regional autonomy, ensuring unity without sacrificing local identity. The Commonwealth stands as a modern, disciplined state committed to order, progress, and the protection of its citizens."
        ].join("\n\n")
      }]
    ]);

    const NAME_ALIASES = new Map([
      ["United States", "United States of America"],
      ["USA", "United States of America"]
    ]);

    function canonicalName(name){
      const n = (name || "").trim();
      return NAME_ALIASES.get(n) || n;
    }

    function statusOf(name){
      const n = canonicalName(name);
      if (FICTIONAL.has(n)) return FICTIONAL.get(n).status;
      if (OFN.founding.has(n)) return "founding";
      if (OFN.members.has(n)) return "member";
      if (OFN.observer.has(n)) return "observer";
      if (OFN.invite.has(n)) return "invite";
      if (OFN.conflict.has(n)) return "conflict";
      return "neutral";
    }

    function statusLabel(s){
      return ({
        founding:"Founding nation",
        member:"Member nation",
        observer:"Observer state",
        invite:"Open invite",
        conflict:"Conflict",
        neutral:"Neutral"
      }[s] || "Neutral");
    }

    function badgeClass(s){
      return ({
        member:"member",
        founding:"founding",
        observer:"observer",
        invite:"invite",
        conflict:"conflict",
        neutral:"neutral"
      }[s] || "neutral");
    }

    function statusColor(s){
      const css = getComputedStyle(document.documentElement);
      const val = ({
        member: css.getPropertyValue("--member").trim(),
        founding: css.getPropertyValue("--founding").trim(),
        observer: css.getPropertyValue("--observer").trim(),
        invite: css.getPropertyValue("--invite").trim(),
        conflict: css.getPropertyValue("--conflict").trim(),
        neutral: css.getPropertyValue("--neutral").trim()
      }[s] || css.getPropertyValue("--neutral").trim());
      return val;
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    const el = (id) => document.getElementById(id);
    const normalize = (s) => (s||"").toLowerCase().replace(/\s+/g," ").trim();

    let map, baseLayer = null, countriesLayer;
    let selectedFeature = null;
    let selectedName = null;
    let memberFocus = false;

    // clock mode
    let clockMode = false;
    let clockTickTimer = null;

    const topbar = el("topbar");
    const statusline = el("statusline");
    const drawer = el("drawer");
    const drawerBody = el("drawerBody");

    function getAutoTheme(){
      const h = new Date().getHours();
      return (h >= 7 && h < 19) ? "day" : "night";
    }

    function setBaseTiles(mode){
      if (!map) return;
      const actual = (mode === "auto") ? getAutoTheme() : mode;
      const night = actual === "night";

      const url = night
        ? "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
        : "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";

      if (baseLayer) baseLayer.remove();

      baseLayer = L.tileLayer(url, {
        subdomains: "abcd",
        maxZoom: 7,
        minZoom: 2,
        attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
      }).addTo(map);
    }

    function applyTheme(mode){
      const root = document.documentElement;
      let actual = mode;
      if (mode === "auto") actual = getAutoTheme();
      root.setAttribute("data-theme", actual);

      setBaseTiles(mode);
      syncFictionToggleIcon();
      updateClockLine();
    }

    function startThemeClock(){
      setInterval(() => {
        const sel = el("theme");
        if (sel && sel.value === "auto") applyTheme("auto");
      }, 60 * 1000);
    }

    function setStatusLine(name){
      if (!name){
        el("selName").textContent = "No selection";
        el("selStatus").textContent = "‚Äî";
        updateClockLine();
        return;
      }
      const s = statusOf(name);
      el("selName").textContent = name;
      el("selStatus").textContent = statusLabel(s);
      updateClockLine();
    }

    function openDrawer(){ drawer.classList.add("open"); }
    function closeDrawer(){ drawer.classList.remove("open"); }

    function makeBadge(text, cls){
      return `<span class="badge ${cls}">${escapeHTML(text)}</span>`;
    }

    function situationBadges(name){
      const s = statusOf(name);
      const badges = [];
      badges.push(makeBadge(statusLabel(s), badgeClass(s)));
      if (canonicalName(name) === OFN.hq) badges.push(makeBadge("Headquarters", "hq"));
      if (FICTIONAL.has(canonicalName(name))) badges.push(makeBadge("Fictional", "hq"));
      return badges.join("");
    }

    function setDrawerHeader(name){
      const n = canonicalName(name);
      el("dName").textContent = n;
      if (FICTIONAL.has(n)) el("dFlag").textContent = FICTIONAL.get(n).flag || "üó∫Ô∏è";
      else el("dFlag").textContent = "üåç";
      el("dMini").innerHTML = situationBadges(n);
    }

    // Fix Georgia ambiguity + detect disambiguation
    const DISAMBIG_OVERRIDES = new Map([
      ["Georgia", "Georgia (country)"]
    ]);

    async function fetchWikiSummary(title){
      const t = encodeURIComponent(title.replace(/\s+/g, "_"));
      const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${t}`;
      const res = await fetch(url, { headers: { "accept":"application/json" } });
      if (!res.ok) throw new Error("wiki");
      return await res.json();
    }

    function paragraphsToHtml(text){
      const parts = String(text || "").split(/\n\s*\n/g).map(s => s.trim()).filter(Boolean);
      if (!parts.length) return `<p class="note" style="margin:0;">‚Äî</p>`;
      return parts.map(p => `<p class="note" style="margin:0 0 10px 0;">${escapeHTML(p)}</p>`).join("").replace(/<\/p>$/, "</p>");
    }

    function renderMetaGrid(meta){
      if (!meta) return "";
      const entries = Object.entries(meta);
      if (!entries.length) return "";
      const items = entries.map(([k,v]) => `
        <div class="kv">
          <div class="k">${escapeHTML(k)}</div>
          <div class="v">${escapeHTML(v)}</div>
        </div>
      `).join("");
      return `<div class="grid2">${items}</div>`;
    }

    function fillDrawerFictional(name){
      const n = canonicalName(name);
      const data = FICTIONAL.get(n);
      if (!data){
        setDrawerHeader(n);
        drawerBody.innerHTML = `<div class="card"><h3>Overview</h3><p class="note" style="margin:0;">No local record found.</p></div>`;
        return;
      }

      setDrawerHeader(n);

      const s = statusOf(n);
      const cards = [];

      cards.push(`
        <div class="card">
          <h3>Status</h3>
          <div class="grid2">
            <div class="kv"><div class="k">Designation</div><div class="v">${escapeHTML(statusLabel(s))}</div></div>
            <div class="kv"><div class="k">OFN</div><div class="v">${escapeHTML((canonicalName(n) === OFN.hq) ? "Headquarters" : "‚Äî")}</div></div>
          </div>
        </div>
      `);

      if (data.meta){
        cards.push(`
          <div class="card">
            <h3>Key facts</h3>
            ${renderMetaGrid(data.meta)}
          </div>
        `);
      }

      cards.push(`
        <div class="card">
          <h3>Overview</h3>
          ${paragraphsToHtml(data.overview)}
        </div>
      `);

      drawerBody.innerHTML = cards.join("");
    }

    async function fillDrawerFromInternet(name){
      const n = canonicalName(name);

      if (FICTIONAL.has(n)){
        fillDrawerFictional(n);
        return;
      }

      setDrawerHeader(n);

      const s = statusOf(n);
      const cards = [];

      cards.push(`
        <div class="card">
          <h3>Status</h3>
          <div class="grid2">
            <div class="kv"><div class="k">Designation</div><div class="v">${escapeHTML(statusLabel(s))}</div></div>
            <div class="kv"><div class="k">OFN</div><div class="v">${escapeHTML((canonicalName(n) === OFN.hq) ? "Headquarters" : "‚Äî")}</div></div>
          </div>
        </div>
      `);

      let wiki = null;
      let titleToTry = DISAMBIG_OVERRIDES.get(n) || n;

      try{ wiki = await fetchWikiSummary(titleToTry); }catch(_){}

      if (wiki && wiki.type === "disambiguation"){
        const retry = DISAMBIG_OVERRIDES.get(n) || (n === "Georgia" ? "Georgia (country)" : null);
        if (retry){
          try{ wiki = await fetchWikiSummary(retry); }catch(_){}
        }
      }

      if (!wiki && n === "United States of America"){
        try{ wiki = await fetchWikiSummary("United States"); }catch(_){}
      }

      if (wiki && (wiki.extract || wiki.description) && wiki.type !== "disambiguation"){
        const extract = wiki.extract ? escapeHTML(wiki.extract) : "";
        const desc = wiki.description ? escapeHTML(wiki.description) : "";
        const page = wiki.content_urls && wiki.content_urls.desktop && wiki.content_urls.desktop.page ? wiki.content_urls.desktop.page : null;

        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            ${desc ? `<p class="note" style="margin:0 0 10px 0;">${desc}</p>` : ""}
            <p class="note" style="margin:0;">${extract || "‚Äî"}</p>
            ${page ? `<p style="margin:10px 0 0 0;"><a class="link" href="${page}" target="_blank" rel="noopener noreferrer">Open source</a></p>` : ""}
          </div>
        `);
      } else {
        cards.push(`
          <div class="card">
            <h3>Overview</h3>
            <p class="note" style="margin:0;">Could not load an external summary right now.</p>
          </div>
        `);
      }

      drawerBody.innerHTML = cards.join("");
    }

    function currentFilter(){
      return el("filter") ? el("filter").value : "all";
    }

    function matchesFilter(status){
      const f = currentFilter();
      if (f === "all") return true;
      return status === f;
    }

    function styleFeature(feature){
      const name = canonicalName(feature.properties?.name || "");
      const s = statusOf(name);
      const color = statusColor(s);

      let fillOpacity = 0.30;
      if (s === "member" || s === "founding") fillOpacity = 0.58;
      if (s === "observer") fillOpacity = 0.44;
      if (s === "invite") fillOpacity = 0.44;
      if (s === "conflict") fillOpacity = 0.52;

      let opacity = 0.70;
      let weight = 1.25;

      const match = matchesFilter(s);
      if (!match){
        fillOpacity = Math.min(fillOpacity, 0.08);
        opacity = 0.10;
      }

      if (memberFocus && selectedName){
        const selStatus = statusOf(selectedName);
        const selectedIsMember = (selStatus === "member" || selStatus === "founding");
        if (selectedIsMember){
          const thisIsMember = (s === "member" || s === "founding");
          if (!thisIsMember){
            fillOpacity = Math.min(fillOpacity, 0.06);
            opacity = Math.min(opacity, 0.09);
            weight = 1;
          } else {
            fillOpacity = Math.max(fillOpacity, 0.64);
            opacity = Math.max(opacity, 0.84);
            weight = 1.45;
          }
        }
      }

      const isDay = document.documentElement.getAttribute("data-theme") === "day";
      return {
        color: isDay ? "rgba(0,0,0,.34)" : "rgba(238,243,255,.18)",
        weight,
        fillColor: color,
        fillOpacity,
        opacity
      };
    }

    function setFeatureHover(layer, on){
      if (!layer || !layer.feature) return;
      if (selectedFeature === layer) return;

      if (on){
        layer.setStyle({
          weight: 2.4,
          color: "rgba(43,109,255,.55)",
          fillOpacity: 0.72
        });
      } else {
        layer.setStyle(styleFeature(layer.feature));
      }
    }

    function refreshStyles(){
      if (!countriesLayer) return;
      countriesLayer.eachLayer((layer) => layer.setStyle(styleFeature(layer.feature)));
      if (selectedFeature){
        selectedFeature.setStyle({
          weight: 3.0,
          color: "rgba(43,109,255,.75)",
          fillOpacity: 0.82,
          opacity: 0.95
        });
      }
    }

    function selectLayer(layer){
      if (!layer || !layer.feature) return;

      if (selectedFeature && selectedFeature !== layer){
        selectedFeature.setStyle(styleFeature(selectedFeature.feature));
      }
      selectedFeature = layer;

      const name = canonicalName(layer.feature.properties?.name || "");
      selectedName = name;

      layer.setStyle({
        weight: 3.0,
        color: "rgba(43,109,255,.75)",
        fillOpacity: 0.82,
        opacity: 0.95
      });

      setStatusLine(name);
      openDrawer();

      const badges = situationBadges(name);
      const popupHtml = `<b>${escapeHTML(name)}</b><div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">${badges}</div>`;
      layer.bindPopup(popupHtml).openPopup();

      fillDrawerFromInternet(name).catch(() => {
        setDrawerHeader(name);
        drawerBody.innerHTML = `<div class="card"><h3>Overview</h3><p class="note" style="margin:0;">Could not load summary right now.</p></div>`;
      });

      refreshStyles();
      updateClockLine();
    }

    function selectFictional(name){
      const n = canonicalName(name);

      if (selectedFeature){
        selectedFeature.setStyle(styleFeature(selectedFeature.feature));
      }
      selectedFeature = null;
      selectedName = n;

      setStatusLine(n);
      openDrawer();

      if (map) map.closePopup();
      fillDrawerFictional(n);

      refreshStyles();
      updateClockLine();
    }

    function zoomToSelected(){
      if (!selectedFeature) return;
      try{ map.fitBounds(selectedFeature.getBounds().pad(0.25)); }catch(_){}
    }

    function findCountryLayerByName(query){
      const q = normalize(canonicalName(query));
      if (!q || !countriesLayer) return null;

      let exact = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (name === q) exact = layer;
      });
      if (exact) return exact;

      let partial = null;
      countriesLayer.eachLayer((layer) => {
        const name = normalize(canonicalName(layer.feature.properties?.name || ""));
        if (!partial && name.includes(q)) partial = layer;
      });
      return partial;
    }

    // ---------- CLOCK MODE (timezone-ish) ----------
    function pad2(n){ return String(n).padStart(2, "0"); }

    // approximate timezone offset from longitude, rounded to nearest hour
    function approxUtcOffsetHoursFromLng(lng){
      if (!isFinite(lng)) return null;
      let off = Math.round(lng / 15);
      off = Math.max(-12, Math.min(14, off));
      return off;
    }

    function utcNow(){
      const d = new Date();
      return new Date(d.getTime() + d.getTimezoneOffset() * 60000);
    }

    function formatUtcHHMM(dateUtc){
      return `${pad2(dateUtc.getUTCHours())}:${pad2(dateUtc.getUTCMinutes())}`;
    }

    function luxembourgTimeHHMM(){
      try{
        const d = new Date();
        const fmt = new Intl.DateTimeFormat("en-GB", { timeZone: "Europe/Luxembourg", hour:"2-digit", minute:"2-digit", hour12:false });
        return fmt.format(d);
      }catch(_){
        const d = new Date();
        return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }
    }

    function selectedCentroidLng(){
      if (!selectedFeature) return null;
      try{
        const b = selectedFeature.getBounds();
        const c = b.getCenter();
        return c.lng;
      }catch(_){
        return null;
      }
    }

    function updateClockLine(){
      const info = el("clockInfo");
      const text = el("clockText");
      if (!info || !text) return;

      if (!clockMode){
        info.classList.remove("on");
        text.textContent = "";
        return;
      }

      info.classList.add("on");

      const u = utcNow();
      const utcStr = `UTC ${formatUtcHHMM(u)}`;
      const hqStr = `HQ ${luxembourgTimeHHMM()}`;

      if (!selectedName){
        text.textContent = `${utcStr} ¬∑ ${hqStr}`;
        return;
      }

      if (FICTIONAL.has(canonicalName(selectedName))){
        text.textContent = `${utcStr} ¬∑ ${hqStr}`;
        return;
      }

      const lng = selectedCentroidLng();
      const off = approxUtcOffsetHoursFromLng(lng);

      if (off === null){
        text.textContent = `${utcStr} ¬∑ ${hqStr}`;
        return;
      }

      const localMs = u.getTime() + off * 3600000;
      const local = new Date(localMs);
      const sign = off >= 0 ? "+" : "‚àí";
      const abs = Math.abs(off);
      const selStr = `${pad2(local.getUTCHours())}:${pad2(local.getUTCMinutes())} (UTC${sign}${abs})`;

      text.textContent = `${selStr} ¬∑ ${hqStr} ¬∑ ${utcStr}`;
    }

    function setClockMode(on){
      clockMode = !!on;
      el("clockBtn").textContent = `Clock: ${clockMode ? "On" : "Off"}`;
      updateClockLine();

      if (clockTickTimer) clearInterval(clockTickTimer);
      if (clockMode){
        clockTickTimer = setInterval(updateClockLine, 1000);
      } else {
        clockTickTimer = null;
      }
    }

    // ---------- INTRO ----------
    function iso2FromName(name){
      const n = canonicalName(name);
      const mapIso = new Map([
        ["Luxembourg","LU"],
        ["Falkland Islands","FK"],
        ["Israel","IL"],
        ["United States of America","US"],
        ["Philippines","PH"],
        ["Brazil","BR"],
        ["Georgia","GE"],
        ["Ireland","IE"],
        ["Greece","GR"],
        ["Australia","AU"],
        ["Portugal","PT"],
        ["China","CN"],
        ["Japan","JP"],
        ["France","FR"],
        ["Qatar","QA"]
      ]);
      return mapIso.get(n) || null;
    }

    function twemojiFlagUrlFromISO2(iso2){
      const A = "A".codePointAt(0);
      const cps = iso2.toUpperCase().split("").map(ch => (0x1F1E6 + (ch.codePointAt(0) - A)).toString(16));
      return `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/${cps.join("-")}.png`;
    }

    function loadImage(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function drawStar(ctx, cx, cy, spikes, outerR, innerR){
      let rot = Math.PI / 2 * 3;
      const step = Math.PI / spikes;

      ctx.beginPath();
      ctx.moveTo(cx, cy - outerR);
      for (let i = 0; i < spikes; i++){
        ctx.lineTo(cx + Math.cos(rot) * outerR, cy + Math.sin(rot) * outerR);
        rot += step;
        ctx.lineTo(cx + Math.cos(rot) * innerR, cy + Math.sin(rot) * innerR);
        rot += step;
      }
      ctx.closePath();
    }

    async function runIntroAnimation(){
      const intro = el("intro");
      const canvas = el("introCanvas");
      const ctx = canvas.getContext("2d", { alpha: true });
      if (!ctx){
        finishIntro();
        return;
      }

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(canvas.clientWidth * dpr);
        canvas.height = Math.floor(canvas.clientHeight * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize, { passive:true });

      const realMembers = Array.from(OFN.members);
      const fictionalMembers = Array.from(FICTIONAL.entries())
        .filter(([_, data]) => data.status === "member")
        .map(([name]) => name);
      const members = [...realMembers, ...fictionalMembers];

      const nodes = [];
      for (const name of members){
        const iso2 = iso2FromName(name);
        let img = null;

        if (iso2){
          try{ img = await loadImage(twemojiFlagUrlFromISO2(iso2)); } catch(_){ img = null; }
        }

        if (!img && FICTIONAL.has(name)){
          const icon = FICTIONAL.get(name).flag || "üó∫Ô∏è";
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = 64; tempCanvas.height = 64;
          const tctx = tempCanvas.getContext("2d");
          tctx.font = "48px system-ui";
          tctx.textAlign = "center";
          tctx.textBaseline = "middle";
          tctx.fillStyle = "#ffffff";
          tctx.fillText(icon, 32, 36);
          img = tempCanvas;
        }

        nodes.push({ name, iso2, img, phase: Math.random() * Math.PI * 2 });
      }

      const orbitSeconds = 2.0;
      const flySeconds = 0.7;
      const fadeInSeconds = 0.55;
      const total = orbitSeconds + flySeconds + fadeInSeconds;
      let t0 = performance.now();

      function tick(now){
        const t = (now - t0)/1000;
        const w = canvas.clientWidth;
        const h = canvas.clientHeight;

        ctx.clearRect(0,0,w,h);

        const isDay = document.documentElement.getAttribute("data-theme") === "day";
        ctx.fillStyle = isDay ? "#0b1020" : "#0b1020";
        ctx.fillRect(0,0,w,h);

        const cx = w*0.5, cy = h*0.5;
        const R = Math.min(w,h)*0.26;

        const orbitT = Math.min(1, t / orbitSeconds);
        const flyT = Math.max(0, Math.min(1, (t - orbitSeconds)/flySeconds));
        const fadeT = Math.max(0, Math.min(1, (t - orbitSeconds - flySeconds)/fadeInSeconds));

        ctx.strokeStyle = "rgba(180,210,255,.16)";
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI*2); ctx.stroke();

        const pulse = 0.5 + 0.5*Math.sin(t*2.2);
        ctx.fillStyle = `rgba(255,204,51,${0.18 + 0.10*pulse})`;
        ctx.beginPath(); ctx.arc(cx, cy, 4 + 2*pulse, 0, Math.PI*2); ctx.fill();

        const n = Math.max(1, nodes.length);
        const spin = t * 0.9;

        for (let i=0;i<nodes.length;i++){
          const node = nodes[i];
          const a = (i/n)*Math.PI*2 + spin;
          const wob = 1 + 0.02*Math.sin(t*2.8 + node.phase);
          let rr = R * wob;

          let x = cx + Math.cos(a)*rr;
          let y = cy + Math.sin(a)*rr;

          let alpha = Math.min(1, 0.10 + orbitT*0.90);

          if (flyT > 0){
            const dir = (i % 2 === 0) ? 1 : -1;
            x += dir * flyT * (w*0.58);
            y += (Math.sin(a)*flyT) * (h*0.10);
            alpha *= (1 - flyT);
          }

          ctx.save();

          ctx.globalAlpha = 0.70 * alpha;
          ctx.fillStyle = "rgba(255,204,51,.22)";
          drawStar(ctx, x, y, 5, 18, 8);
          ctx.fill();

          ctx.globalAlpha = 0.45 * alpha;
          ctx.strokeStyle = "rgba(180,210,255,.12)";
          ctx.lineWidth = 1;
          drawStar(ctx, x, y, 5, 18, 8);
          ctx.stroke();

          ctx.globalAlpha = 1.0 * alpha;
          if (node.img){
            const size = 22;
            ctx.drawImage(node.img, x - size/2, y - size/2, size, size);
          } else {
            ctx.fillStyle = "rgba(238,243,255,.92)";
            ctx.font = "14px system-ui";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText((node.iso2 || node.name.slice(0,2).toUpperCase()), x, y);
          }

          ctx.restore();
        }

        topbar.classList.toggle("ready", fadeT > 0.05);
        statusline.classList.toggle("ready", fadeT > 0.20);

        if (t < total) requestAnimationFrame(tick);
        else finishIntro();
      }

      requestAnimationFrame(tick);

      function finishIntro(){
        intro.classList.add("hidden");
        setTimeout(() => intro.remove(), 600);
        topbar.classList.add("ready");
        statusline.classList.add("ready");
      }
    }

    // ---------- Map init ----------
    function initMap(){
      map = L.map("map", {
        zoomControl: false,
        worldCopyJump: true,
        preferCanvas: true,
        minZoom: 2,
        maxZoom: 7,
        maxBounds: L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180)),
        maxBoundsViscosity: 1.0
      }).setView([22, 0], 2);

      L.control.zoom({ position: "bottomright" }).addTo(map);

      applyTheme("auto");
      setBaseTiles("auto");

      const geoUrl = `https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson?v=${encodeURIComponent(BUILD_VERSION)}`;

      fetch(geoUrl)
        .then(r => r.json())
        .then(geo => {
          countriesLayer = L.geoJSON(geo, {
            style: styleFeature,
            onEachFeature: (feature, layer) => {
              layer.on("mouseover", () => setFeatureHover(layer, true));
              layer.on("mouseout", () => setFeatureHover(layer, false));
              layer.on("click", () => selectLayer(layer));
            }
          }).addTo(map);

          const bounds = countriesLayer.getBounds();
          if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.02));

          wireUI();
          wireFictionPanel();
          startThemeClock();
          runIntroAnimation();
        })
        .catch(() => {
          wireUI();
          wireFictionPanel();
          startThemeClock();
          runIntroAnimation();
        });
    }

    function wireFictionPanel(){
      const panel = el("fictionPanel");
      const toggle = el("fictionToggle");
      const list = el("fictionList");

      const items = Array.from(FICTIONAL.entries()).map(([name, data]) => ({ name, ...data }));
      const order = { founding:0, member:1, observer:2, invite:3, neutral:4, conflict:5 };
      items.sort((a,b) => (order[a.status] ?? 9) - (order[b.status] ?? 9) || a.name.localeCompare(b.name));

      const miniClass = (s) => (s === "member" ? "member" : (s === "invite" ? "invite" : "neutral"));

      list.innerHTML = items.map(it => `
        <div class="fictionItem" role="button" tabindex="0" data-name="${encodeURIComponent(it.name)}" title="Open ${escapeHTML(it.name)}">
          <div class="left">
            <div class="name">${escapeHTML(it.name)}</div>
            <div class="sub">${escapeHTML(statusLabel(it.status))}</div>
          </div>
          <div class="right">
            <div class="miniBadge ${miniClass(it.status)}">${escapeHTML(statusLabel(it.status))}</div>
          </div>
        </div>
      `).join("");

      function setOpen(open){
        panel.classList.toggle("closed", !open);
        syncFictionToggleIcon();
      }

      toggle.addEventListener("click", () => setOpen(panel.classList.contains("closed")));

      list.addEventListener("click", (e) => {
        const item = e.target.closest(".fictionItem");
        if (!item) return;
        const raw = item.getAttribute("data-name") || "";
        const name = decodeURIComponent(raw);
        if (FICTIONAL.has(name)) selectFictional(name);
      });

      list.addEventListener("keydown", (e) => {
        if (e.key !== "Enter" && e.key !== " ") return;
        const item = e.target.closest(".fictionItem");
        if (!item) return;
        e.preventDefault();
        const raw = item.getAttribute("data-name") || "";
        const name = decodeURIComponent(raw);
        if (FICTIONAL.has(name)) selectFictional(name);
      });

      setOpen(false);
    }

    function syncFictionToggleIcon(){
      const panel = el("fictionPanel");
      const toggle = el("fictionToggle");
      if (!panel || !toggle) return;
      const isClosed = panel.classList.contains("closed");
      toggle.textContent = isClosed ? "‚óÄ" : "‚ñ∂";
      toggle.title = isClosed ? "Show fictional nations" : "Hide fictional nations";
    }

    // ---------- OFN modal ----------
    function setOFNModal(open){
      const overlay = el("ofnOverlay");
      if (!overlay) return;
      overlay.classList.toggle("open", !!open);
    }

    // ---------- UI wiring ----------
    function wireUI(){
      el("closeBtn").addEventListener("click", closeDrawer);

      el("zoomBtn").addEventListener("click", () => {
        if (selectedFeature) zoomToSelected();
      });

      el("fitBtn").addEventListener("click", () => {
        if (countriesLayer){
          const b = countriesLayer.getBounds();
          if (b && b.isValid()) map.fitBounds(b.pad(0.02));
        } else {
          map.setView([22,0], 2);
        }
      });

      el("resetBtn").addEventListener("click", () => {
        el("search").value = "";
        el("filter").value = "all";
        el("theme").value = "auto";
        memberFocus = false;
        el("focusBtn").textContent = "Member focus: Off";
        closeDrawer();
        selectedName = null;

        if (selectedFeature){
          selectedFeature.setStyle(styleFeature(selectedFeature.feature));
        }
        selectedFeature = null;

        setStatusLine(null);
        refreshStyles();
        applyTheme("auto");
        if (map) map.closePopup();

        setClockMode(false);
        setOFNModal(false);
      });

      el("filter").addEventListener("change", refreshStyles);

      el("theme").addEventListener("change", (e) => applyTheme(e.target.value));

      el("focusBtn").addEventListener("click", () => {
        memberFocus = !memberFocus;
        el("focusBtn").textContent = `Member focus: ${memberFocus ? "On" : "Off"}`;
        refreshStyles();
      });

      el("clockBtn").addEventListener("click", () => setClockMode(!clockMode));

      // OFN button + modal behavior
      el("ofnBtn").addEventListener("click", () => setOFNModal(true));
      el("ofnClose").addEventListener("click", () => setOFNModal(false));
      el("ofnOverlay").addEventListener("click", (e) => {
        if (e.target === el("ofnOverlay")) setOFNModal(false);
      });

      const searchEl = el("search");
      const doSearch = () => {
        const q = searchEl.value.trim();
        if (!q) return;

        const qCan = canonicalName(q);
        if (FICTIONAL.has(qCan)){
          selectFictional(qCan);
          return;
        }

        const layer = findCountryLayerByName(q);
        if (layer){
          selectLayer(layer);
          try{ map.fitBounds(layer.getBounds().pad(0.25)); }catch(_){}
        }
      };
      searchEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape"){
          closeDrawer();
          setOFNModal(false);
        }
      });

      setClockMode(false);
    }

    // boot
    setStatusLine(null);
    initMap();
  </script>
</body>
</html>
